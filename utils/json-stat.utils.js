var JSONstatUtils=function(){"use strict";function t(t){function e(e){void 0!==t.selector?t.selector.innerHTML=c[e]:window.alert(c[e])}function n(t,e,n){var r={filter:{}};return n.forEach(function(t){"rows"===t.name||"cols"===t.name?r[t.name]=t.value:r.filter[t.name]=t.value}),"rowscols"===e&&(r.filter={},t.id.forEach(function(e,n){e!==r.rows&&e!==r.cols&&(r.filter[e]=t.Dimension(n).id[0])})),r}function r(t,e){var n,r,l={},o=[],i=t.id;if(e){var a="bigger"===e?function(t,e){return t.len<e.len?1:-1}:function(t,e){return t.len>e.len?1:-1};t.Dimension().forEach(function(t,e){o.push({id:i[e],len:t.length})}),o.sort(a),n=o[0].id,r=o[1].id}else n=i[0],r=i[1];return t.Dimension(n).length<t.Dimension(r).length&&(n=r+(r=n,"")),i.forEach(function(e){e!==n&&e!==r&&(l[e]=t.Dimension(e).id[0])}),{rows:n,cols:r,filter:l}}function o(t){var e=[],n=[].slice.call(t.querySelectorAll("select, input"));return n.forEach(function(t){e.push({name:t.name,value:t.value})}),e}function i(t,e){var n=function(t,e){return t&&"metric"===t.role&&e.unit&&e.unit.hasOwnProperty("label")?" ("+e.unit.label+")":""};return e.label.capitalize()+n(t,e)}function a(t,e,n){var r,l='<select name="'+e+'">',o=[];if(null!==n[1]){if(r=t.id,o=t.Dimension(),2===r.length)return(t.Dimension(n[0]).label||n[0]).capitalize()}else{var a=t.Dimension(e);if(r=a.id,o=a.Category(),1===r.length)return}return r.forEach(function(t,e){var r=t!==n[0]?"":'selected="selected" ';(null===n[1]||t!==n[1])&&(l+="<option "+r+'value="'+t+'">'+i(a,o[e])+"</option>")}),l+="</select>"}function s(t,e,r){var l="",u="",d="",h="",g=r.rows,p=e.Dimension(g),m=p.id,b=r.cols,y=e.Dimension(b),w=y.id,S=e.role&&e.role.metric?e.role.metric[0]:null,D=null!==S?e.Dimension(S):null,j=function(t){return t.hasOwnProperty("unit")&&t.unit&&t.unit.hasOwnProperty("decimals")?t.unit.decimals:null},E=r.filter,O=JSON.parse(JSON.stringify(E)),N=[],C="",x="",R=e.source?c.source+": "+e.source+".":"",J=null!==e.label?'<span class="label">'+e.label.capitalize()+"</span>":"";d+="<caption>"+J,d+=' <form><fieldset id="rowscols"><legend>'+c.rc+"</legend>"+a(e,"rows",[g,b])+" <a>&#x2194;</a> "+a(e,"cols",[b,g])+"</fieldset>";for(var L in E){var q=e.Dimension(L),z=q.label.capitalize();q.length>1?C+="<p>"+a(e,L,[E[L],null])+" <strong>"+z+"</strong></p>":N.push({label:z,value:i(q,q.Category(0)),name:L,id:q.id[0]})}""!==C&&(C='<fieldset id="filters"><legend>'+c.filters+"</legend>"+C+"</fieldset>"),N.forEach(function(t){x+="<p>"+t.value+" <strong>"+t.label+'</strong></p><input type="hidden" name="'+t.name+'" value="'+t.id+'" />'}),""!==x&&(x='<fieldset id="constants"><legend>'+c.constants+"</legend>"+x+"</fieldset>"),d+=C+x+"</form></caption>",h+="<tbody>";var A=Number.toLocaleString?function(t,e){return null===e?t.toLocaleString(f):t.toLocaleString(f,{minimumFractionDigits:e,maximumFractionDigits:e})}:function(t,e){return null===e?t:t.toFixed(e)};return m.forEach(function(t){O[g]=t;var n=e.Data(O),r=function(t,e){var n,r=b!==S?null===D?null:j(D.Category(O[S])):j(y.Category(e));null!==t.value?(n=A(t.value,r),v&&null!==t.status&&(n+=" ("+t.status+")")):n=t.status||c.na,h+="<td>"+n+"</td>"};return null===n?void(h="ERROR"):(h+='<tr><th scope="row">'+i(p,p.Category(t))+"</th>","[object Array]"===Object.prototype.toString.call(n)?n.forEach(function(t,e){r(t,e)}):r(n,0),void(h+="</tr>"))}),"ERROR"===h?c.dataerror:(h+="</tbody>",l+="<thead><tr><th></th>",w.forEach(function(t){l+='<th scope="col">'+i(y,y.Category(t))+"</th>"}),l+="</tr></thead>",""!==R&&(u='<tfoot><tr><td colspan="'+(w.length+1)+'">'+R+"</td></tr></tfoot>"),t.innerHTML="<table>"+d+l+u+h+"</table>",[].slice.call(t.querySelectorAll("select")).forEach(function(r){r.addEventListener("change",function(r){s(t,e,n(e,r.target.parentElement.getAttribute("id"),o(t)))},!1)}),void t.querySelector("a").addEventListener("click",function(){r.cols=g,r.rows=b,s(t,e,r)},!1))}var u,c=void 0===t.i18n||void 0===t.i18n.msgs?{selerror:'tbrowser: "selector" property is required!',urierror:'tbrowser: "jsonstat" property is required!',jsonerror:"Document is not valid JSON-stat.",dserror:"Dataset ID is not correct.",dimerror:"Only one dimension was found in the dataset. At least two are required.",dataerror:"Selection returned no data!",source:"Source",filters:"Filters",constants:"Constants",rc:"Rows &amp; Columns",na:"n/a"}:t.i18n.msgs,f=void 0===t.i18n||void 0===t.i18n.locale?"en-US":t.i18n.locale,d=t.dsid||0,v=t.status||!1;if(void 0===t.selector)return void e("selerror");if(void 0===t.jsonstat)return void e("urierror");if(u="string"==typeof t.jsonstat?JSONstat(t.jsonstat):void 0===t.jsonstat.length?JSONstat(t.jsonstat):t.jsonstat,0===u.length)return void e("jsonerror");var h="dataset"===u["class"]?u:u.Dataset(d);return l(h)?null===h?void e("dserror"):1===h.length?void e("dimerror"):void s(t.selector,h,r(h,t.preset)):void e("jsonerror")}function e(t){var e,n,r,o=t.na||"n/a",i=t.dsid||0,a="",s=0;return void 0===t.jsonstat?null:(r="string"==typeof t.jsonstat?JSONstat(t.jsonstat):void 0===t.jsonstat.length?JSONstat(t.jsonstat):t.jsonstat,0===r.length?null:(n="dataset"===r["class"]?r:r.Dataset(i),null!==n&&l(n)?(e=n.toTable(),s=e[0].length-1,e.forEach(function(t,e){a+=e?'<tr><td class="value">'+e+"</td>":'<tr><th class="value">#</th>',t.forEach(function(t,n){var r=s===n?' class="value"':"",l=null===t?o:t;a+=e?"<td"+r+">"+l+"</td>":"<th"+r+">"+l+"</th>"}),a+="</tr>"}),"<table><caption>"+(t.caption||n.label)+"</caption><tbody>"+a+"</tbody></table>"):null))}function n(t){var e=t.vfield||"Value",n=t.sfield||"Status",r=t.type||"array",l=t.table,o=t.label||"",i=[],a=[],s=[],u=[],c={},f={},d=function(t,e){for(var n=1,r=0,l=0;b>l;l++)n*=l>0?e[b-l]:1,r+=n*t[b-l-1];return r},v=function(){var t=l[y][e];s[d(w,a)]=isNaN(t)?null:t};switch(r){case"array":l=function(t){for(var e=t[0],n=t.slice(1),r=[],l=0,o=n.length;o>l;l++){for(var i=0,a=e.length,s={};a>i;i++)s[e[i]]=n[l][i];r.push(s)}return r}(l);break;case"object":l=function(t){for(var e=t.cols.map(function(t){return t.id}),n=t.rows,r=[],l=0,o=n.length;o>l;l++){for(var i=0,a=e.length,s={};a>i;i++)s[e[i]]=n[l].c[i].v;r.push(s)}return r}(l)}var h=l.length;for(var g in l[0])if(g!==e)if(g!==n){i.push(g),c[g]=[];for(var p=0;h>p;p++){var m=l[p][g];-1===c[g].indexOf(m)&&c[g].push(m)}a.push(c[g].length),f[g]={label:g,category:{index:c[g]}}}else v=function(){var t=l[y][e];s[d(w,a)]=isNaN(t)?null:t,u[d(w,a)]=l[y][n]};for(var b=i.length,y=0;h>y;y++){for(var w=[],S=0;b>S;S++){var D=i[S];w.push(c[D].indexOf(l[y][D]))}v()}return f.id=i,f.size=a,{"class":"dataset",label:o,value:s,status:u,dimension:f}}function r(t){var e=t.vfield||"Value",r=t.type||"jsonstat";if(t.table)u=t.table;else{var l,i=null,a=t.delimiter||",",s=";"===a?",":"	"===a?t.decimal||".":".",u=o(t.csv,a),c=u.length,l=u[0].length;if(t.vlast)i=l-1,e=u[0][i];else{for(;l--;)if(u[0][l]===e){i=l;break}if(null===i)return null}if(","===s)for(l=1;c>l;l++)u[l][i]=+u[l][i].replace(",",".");else for(l=1;c>l;l++)u[l][i]=+u[l][i]}return"table"===r?u:n({table:u,vfield:e,sfield:t.sfield||"Status",type:"array",label:t.label})}function l(t){for(var e=t.length,n=1;e--;)n*=t.Dimension(e).length;return n!==t.n?!1:!0}function o(t,e){e=e||",";for(var n,r,l=RegExp("(\\"+e+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+e+"\\r\\n]*))","gi"),o=[[]],i=null;i=l.exec(t);)r=i[1],r.length&&r!=e&&o.push([]),n=i[2]?i[2].replace(RegExp('""',"g"),'"'):i[3],o[o.length-1].push(n);return o}return String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},{tbrowser:t,datalist:e,fromTable:n,fromCSV:r,version:"1.3.0"}}();