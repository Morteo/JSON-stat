/*

JSON-stat Javascript Utilities Suite v. 2.3.1 (requires JJT 0.10+)
https://json-stat.com
https://github.com/badosa/JSON-stat/tree/master/utils

Copyright 2018 Xavier Badosa (https://xavierbadosa.com)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
or implied. See the License for the specific language governing
permissions and limitations under the License.

*/

var JSONstatUtils=function(){"use strict";function e(e,t,n){function l(e){void 0!==t?t.innerHTML=v[e]:window.alert(v[e])}function r(e,t,n){var l={filter:{}};return n.forEach(function(e){"rows"===e.name||"cols"===e.name?l[e.name]=e.value:l.filter[e.name]=e.value}),"rowscols"===t&&e.id.forEach(function(t,n){t!==l.rows&&t!==l.cols?void 0===l.filter[t]&&(l.filter[t]=e.Dimension(n).id[0]):delete l.filter[t]}),l}function i(e,t){var n,l,r={},i=[],a=e.id;if(t){var o="bigger"===t?function(e,t){return e.len<t.len?1:-1}:function(e,t){return e.len>t.len?1:-1};e.Dimension().forEach(function(e,t){i.push({id:a[t],len:e.length})}),i.sort(o),n=i[0].id,l=i[1].id}else n=a[0],l=a[1];return e.Dimension(n).length<e.Dimension(l).length&&(n=l+(l=n,"")),a.forEach(function(t){t!==n&&t!==l&&(r[t]=e.Dimension(t).id[0])}),{rows:n,cols:l,filter:r}}function o(e){var t=[],n=[].slice.call(e.querySelectorAll("select, input"));return n.forEach(function(e){t.push({name:e.name,value:e.value})}),t}function c(e,t,n){var l=function(e,t){var n,l,r="";return e&&"metric"===e.role&&t.unit&&(n=t.unit.hasOwnProperty("label")?t.unit.label:"",l=t.unit.hasOwnProperty("symbol")?t.unit.symbol:"",n+l!==""&&(r=""===l?n:""===n?l:"start"===t.unit.position?l+n:n+" "+l,r=" ("+r+")")),r},r=t.label||n;return r.capitalize()+l(e,t)}function f(e,t,n){var l,r='<select name="'+t+'">',i=[];if(null!==n[1]){if(l=e.id,i=e.Dimension(),2===l.length)return(e.Dimension(n[0]).label||n[0]).capitalize()}else{var a=e.Dimension(t);if(l=a.id,i=a.Category(),1===l.length)return}return l.forEach(function(e,t){var l=e!==n[0]?"":'selected="selected" ';(null===n[1]||e!==n[1])&&(r+="<option "+l+'value="'+e+'">'+c(a,i[t],e)+"</option>")}),r+="</select>"}function d(e,t,n,l){var i="",a="",s="",u="",b=n.rows,g=t.Dimension(b),y=g.id,O=n.cols,S=t.Dimension(O),w=S.id,D=t.role&&t.role.metric?t.role.metric[0]:null,x=null!==D?t.Dimension(D):null,j=function(e){return e.hasOwnProperty("unit")&&e.unit&&e.unit.hasOwnProperty("decimals")?e.unit.decimals:null},N=n.filter,z=JSON.parse(JSON.stringify(N)),C=[],A="",J="",L=t.source?v.source+": "+t.source:"",R=null!==t.label?'<span class="label">'+t.label.capitalize()+"</span>":"";m&&E.length&&(R='<span class="label">'+E.join(". ")+"</span>"),""!==L&&"."!==L.slice(-1)&&(L+="."),s+="<caption>"+R+"<form>";for(var P in N){var _=t.Dimension(P),T=_.label?_.label.capitalize():P.capitalize();_.length>1?A+="<p>"+f(t,P,[N[P],null])+" <strong>"+T+"</strong></p>":C.push({label:T,value:c(_,_.Category(0)),name:P,id:_.id[0]})}""!==A&&(A='<fieldset id="filters"><legend>'+v.filters+"</legend>"+A+"</fieldset>"),C.forEach(function(e){J+="<p>"+e.value+" <strong>"+e.label+'</strong></p><input type="hidden" name="'+e.name+'" value="'+e.id+'" />'}),""!==J&&(J='<fieldset id="constants"><legend>'+v.constants+"</legend>"+J+"</fieldset>"),s+=J+A+'<fieldset id="rowscols"><legend>'+v.rc+"</legend>"+f(t,"rows",[b,O])+" <a>&#x2194;</a> "+f(t,"cols",[O,b])+"</fieldset></form></caption>",u+="<tbody>";var q=Number.toLocaleString?function(e,t){return null===t?e.toLocaleString(h):e.toLocaleString(h,{minimumFractionDigits:t,maximumFractionDigits:t})}:function(e,t){return null===t?e:e.toFixed(t)};return y.forEach(function(e){z[b]=e;var n=t.Data(z),l=function(e,t){var n,l=O!==D?null===x?null:j(x.Category(z[D])):j(S.Category(t));null!==e.value?(n=q(e.value,l),p&&null!==e.status&&(n+=" ("+e.status+")")):n=e.status||v.na,u+="<td>"+n+"</td>"};return null===n?void(u="ERROR"):(u+='<tr><th scope="row">'+c(g,g.Category(e))+"</th>","[object Array]"===Object.prototype.toString.call(n)?n.forEach(function(e,t){l(e,t)}):l(n,0),void(u+="</tr>"))}),"ERROR"===u?v.dataerror:(u+="</tbody>",i+="<thead><tr><th></th>",w.forEach(function(e){i+='<th scope="col">'+c(S,S.Category(e))+"</th>"}),i+="</tr></thead>",""!==L&&(a='<tfoot><tr><td colspan="'+(w.length+1)+'">'+L+"</td></tr></tfoot>"),e.innerHTML='<table class="'+l+'">'+s+i+a+u+"</table>",[].slice.call(e.querySelectorAll("select")).forEach(function(n){n.addEventListener("change",function(n){d(e,t,r(t,n.target.parentElement.getAttribute("id"),o(e)),l)},!1)}),void e.querySelector("a").addEventListener("click",function(){n.cols=b,n.rows=O,d(e,t,n,l)},!1))}if(void 0===e)return void l("urierror");if(void 0===t)return void l("selerror");void 0===n&&(n={});var v=void 0===n.i18n||void 0===n.i18n.msgs?{urierror:"tbrowser: A valid JSON-stat input must be specified.",selerror:"tbrowser: A valid selector must be specified.",jsonerror:"The request did not return a valid JSON-stat dataset.",dimerror:"Only one dimension was found in the dataset. At least two are required.",dataerror:"Selection returned no data!",source:"Source",filters:"Filters",constants:"Constants",rc:"Rows &amp; Columns",na:"n/a"}:n.i18n.msgs,h=void 0===n.i18n||void 0===n.i18n.locale?"en-US":n.i18n.locale,b=n.dsid||0,p=n.status||!1,g=n.tblclass||"",m=n.nonconst||!1,y=s(e,b);if(!a(y))return void l("jsonerror");if(m)var E=u(y);return 1===y.length?void l("dimerror"):void d(t,y,i(y,n.preset),g)}function t(e,t){if(void 0===e)return null;void 0===t&&(t={});var n="",l="",r=0,i=t.na||"n/a",o=t.dsid||0,u=t.vlabel||null,c=t.slabel||null,f=t.counter||!1,d=t.tblclass||"",v=t.numclass||"",h=t.valclass||"",b=t.status||!1,p=t.locale||"en-US",g=t.source||"Source",m=s(e,o),y=Number.toLocaleString?function(e){return e.toLocaleString(p)}:function(e){return e},E=f?function(e,t){n+=t?'<tr><td class="'+v+'">'+t+"</td>":'<tr><th class="'+v+'">#</th>',e.forEach(function(e,l){var r=S===l?' class="'+v+" "+h+'"':"",a=null===e?i:y(e);n+=t?"<td"+r+">"+a+"</td>":"<th"+r+">"+a+"</th>"}),n+="</tr>"}:function(e,t){n+="<tr>",e.forEach(function(e,l){var r=S===l?' class="'+v+" "+h+'"':"",a=null===e?i:y(e);n+=t?"<td"+r+">"+a+"</td>":"<th"+r+">"+a+"</th>"}),n+="</tr>"};if(!a(m))return null;var O=m.toTable({status:b,vlabel:u,slabel:c}),S=O[0].length-1;return O.forEach(function(e,t){E(e,t)}),m.source&&(r=m.length+1,f&&r++,b&&r++,g+=": "+m.source,"."!==g.slice(-1)&&(g+="."),l='<tfoot><td colspan="'+r+'">'+g+"</td></tfoot>"),'<table class="'+d+'"><caption>'+(t.caption||m.label||"")+"</caption>"+l+"<tbody>"+n+"</tbody></table>"}function n(e,t){if(void 0===e)return null;void 0===t&&(t={});var n=t.vlabel||"Value",l=t.slabel||"Status",r=t.type||"array",i=t.label||"",a=[],o=[],s=[],u=[],c={},f={},d=function(e,t){for(var n=1,l=0,r=0;m>r;r++)n*=r>0?t[m-r]:1,l+=n*e[m-r-1];return l},v=function(){var t=e[y][n];s[d(E,o)]=isNaN(t)?null:t};switch(r){case"array":e=function(e){for(var t=e[0],n=e.slice(1),l=[],r=0,i=n.length;i>r;r++){for(var a=0,o=t.length,s={};o>a;a++)s[t[a]]=n[r][a];l.push(s)}return l}(e);break;case"object":e=function(e){for(var t=e.cols.map(function(e){return e.id}),n=e.rows,l=[],r=0,i=n.length;i>r;r++){for(var a=0,o=t.length,s={};o>a;a++)s[t[a]]=n[r].c[a].v;l.push(s)}return l}(e)}var h=e.length;for(var b in e[0])if(b!==n)if(b!==l){a.push(b),c[b]=[];for(var p=0;h>p;p++){var g=e[p][b];-1===c[b].indexOf(g)&&c[b].push(g)}o.push(c[b].length),f[b]={label:b,category:{index:c[b]}}}else v=function(){var t=e[y][n],r=e[y][l];s[d(E,o)]=isNaN(t)?null:t,u[d(E,o)]=""===r?null:r};for(var m=a.length,y=0;h>y;y++){for(var E=[],O=0;m>O;O++){var S=a[O];E.push(c[S].indexOf(e[y][S]))}v()}var w={version:"2.0","class":"dataset",value:s,dimension:f,id:a,size:o};return i&&(w.label=i),u.length&&(w.status=u),w}function l(e,t){return-1!==e.indexOf(t)?'"'+e+'"':e}function r(e,t){if(void 0===e)return null;void 0===t&&(t={});var n="",r="jsonstat",i=t.rich===!0,o=i?"value":t.vlabel||"Value",u=i?"status":t.slabel||"Status",c=t.status===!0,f=t.na||"n/a",d=t.delimiter||",",v=t.separator||"|",h=";"===d?t.decimal||",":t.decimal||".",b=t.dsid||0,p=s(e,b);if(!a(p))return null;i&&(c=!(null===p.status));var g=p.toTable({vlabel:o,slabel:u,status:c,field:i?"id":"label",content:i?"id":"label",type:"array"}),m=g[0].indexOf(o),y=c?g[0].indexOf(u):-1;return g.forEach(function(e,t){e.forEach(function(n,r){t&&r===m?null===n?e[r]=l(f,d):"."!==h&&(e[r]=(e[r]+"").replace(".",h)):t&&r===y&&null===n?e[r]="":e[r]=l(e[r],d)}),n+=e.join(d)+"\n"}),i&&(r+=d+h+d+v+"\n",["label","source","updated","href"].forEach(function(e){p[e]&&(r+=e+d+l(p[e],d)+"\n")}),p.id.forEach(function(e,t){var n=[],i=p.Dimension(t),a=i.role,o=!1;r+="dimension"+d+l(e,d)+d+l(i.label,d)+d+i.length,"metric"===a&&i.__tree__.category.unit&&(o=!0),i.id.forEach(function(e,t){var a=[],s=i.Category(t);r+=d+l(e,d)+d+l(s.label,d),o&&(a.push(s.unit.hasOwnProperty("decimals")?s.unit.decimals:""),a.push(s.unit.label||""),s.unit.symbol&&(a.push(s.unit.symbol),a.push(s.unit.position)),n.push(l(a.join(v),d)))}),"classification"!==a&&(r+=d+i.role,o&&(r+=d+n.join(d))),r+="\n"}),n=r+"data\n"+n),n}function i(e,t){if(void 0===e)return null;void 0===t&&(t={});var l,r,i,a,s=[],u=null,c=!1,f={time:[],geo:[],metric:[]},d="jsonstat"===e.substring(0,8),v=d?"value":t.vlabel,h=d?"status":t.slabel,b=d?e.substring(8,9):t.delimiter||",",p=";"===b?t.decimal||",":t.decimal||".",g=o(e.trim(),b);if(d){for(p=g[0][1],a=g[0][2],g.shift();"data"!==g[0][0];)s.push(g.shift());g.shift()}if(l=g.length,r=g[0].length,void 0!==v){for(;r--;)if(g[0][r]===v){u=r;break}if(null===u)return null}else u=r-1,v=g[0][u];if(","===p)for(r=1;l>r;r++)g[r][u]=+g[r][u].replace(",",".");else for(r=1;l>r;r++)g[r][u]=+g[r][u];return i=n(g,{vlabel:v,slabel:h,type:"array",label:t.label||""}),d&&s.forEach(function(e,t){var t,n,l,r,o,s;switch(e[0]){case"dimension":if(r=i.dimension[e[1]],r.label=e[2],o=r.category,n={},l=2*e[3]+3,e.length>=l){for(t=4;l>t;t++)Object.defineProperty(n,e[t],{value:e[++t],writable:!0,configurable:!0,enumerable:!0}),o.label=n;"string"==typeof e[t]&&-1!==["time","geo","metric"].indexOf(e[t])&&(f[e[t]].push(e[1]),c=!0,"metric"===e[t]&&"string"==typeof e[++t]&&(o.unit={},o.index.forEach(function(n,l){var r=e[t+l].split(a);o.unit[n]={},s=o.unit[n],void 0!==r[0]&&""!==r[0]&&(s.decimals=1*r[0]),void 0!==r[1]&&""!==r[1]&&(s.label=r[1]),void 0!==r[2]&&""!==r[2]&&(s.symbol=r[2]),void 0!==r[1]&&-1!==["start","end"].indexOf(r[3])&&(s.position=r[3])})))}break;case"label":case"source":case"updated":case"href":i[e[0]]=e[1]||""}c&&(i.role=f)}),i}function a(e){if(null===e||0===e.length||"dataset"!==e["class"])return!1;for(var t=e.length,n=1;t--;)n*=e.Dimension(t).length;return n!==e.n?!1:!0}function o(e,t){t=t||",";for(var n,l,r=RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),i=[[]],a=null;a=r.exec(e);)l=a[1],l.length&&l!=t&&i.push([]),n=a[2]?a[2].replace(RegExp('""',"g"),'"'):a[3],i[i.length-1].push(n);return i}function s(e,t){return void 0===e?null:(("string"==typeof e||void 0===e.length)&&(e=JSONstat(e)),0===e.length||"dataset"!==e["class"]&&"collection"!==e["class"]&&"bundle"!==e["class"]?null:"dataset"===e["class"]?e:e.Dataset(t))}function u(e){var t=0,n=e.size.slice(0),l=[];return n.forEach(function(n,r){var i=r-t,a=e.Dimension(i);1===n&&(delete e.__tree__.dimension[e.id[i]],e.size.splice(i,1),e.id.splice(i,1),e.length--,t++,l.push(a.label.capitalize()+": "+a.Category(0).label.capitalize()))}),l}function c(e,t){if(void 0===e||"[object Array]"!==Object.prototype.toString.call(e))return null;var l=JSON.parse(JSON.stringify(e)),r=l[0];if(!r.hasOwnProperty("version")||!r.hasOwnProperty("class")||"dataset"!==r["class"])return null;void 0===t&&(t={});var i=void 0===t.label?null:t.label,a=void 0===t.by?null:t.by,o=[];if(null===a){for(var s=1,u=l.length;u>s;s++)o=o.concat(l[s].value);return r.value=o,null!==i&&(r.label=i),r}var c,f,d,v=function(e,t,n){if("[object Array]"===Object.prototype.toString.call(e))e=e.concat(t);else for(var l in t)e[l]=0===t[l]?n:t[l];return e};l.forEach(function(e,t){var n=JSONstat(e).toTable({status:!0}),l=e.dimension[a].category;0===t?(o=[n[0]],c=l.index,f=l.label,d=l.unit):(c=v(c,l.index,t),f=v(f,l.label,t),d=v(d,l.unit,t)),o=o.concat(n.slice(1))});var h=n(o);return r.value=h.value,r.size=h.size,r.status=h.status||null,r.label=i||"",r.href=null,r.dimension[a].category.index=c||null,r.dimension[a].category.label=f||null,r.dimension[a].category.unit=d||null,r}return String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},{tbrowser:e,datalist:t,fromTable:n,fromCSV:i,toCSV:r,join:c,version:"2.3.1"}}();
