/*
JSON-stat Javascript Utilities Suite v. 2.5.0 (requires JJT ES6 module) (ES6 module)
https://json-stat.com
Copyright 2019 Xavier Badosa (https://xavierbadosa.com)
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
	http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
or implied. See the License for the specific language governing
permissions and limitations under the License.
*/

/* jshint newcap:false */
//////////////////////////////////////////////////////
//tbrowser and killconst removed in ES6 module


import { JSONstat } from "../export.js";

function datalist(e,t){if(void 0===e)return null;void 0===t&&(t={});var a="",n="",l=0,r=t.na||"n/a",o=t.dsid||0,i=t.vlabel||null,s=t.slabel||null,u=t.counter||!1,c=t.tblclass||"",d=t.numclass||"",f=t.valclass||"",h=t.status||!1,v=t.locale||"en-US",b=t.source||"Source",p=dataset(e,o),g=Number.toLocaleString?function(e){return e.toLocaleString(v)}:function(e){return e},m=u?function(e,t){a+=t?'<tr><td class="'+d+'">'+t+"</td>":'<tr><th class="'+d+'">#</th>',e.forEach(function(e,n){var l=O===n?' class="'+d+" "+f+'"':"",o=null===e?r:g(e);a+=t?"<td"+l+">"+o+"</td>":"<th"+l+">"+o+"</th>"}),a+="</tr>"}:function(e,t){a+="<tr>",e.forEach(function(e,n){var l=O===n?' class="'+d+" "+f+'"':"",o=null===e?r:g(e);a+=t?"<td"+l+">"+o+"</td>":"<th"+l+">"+o+"</th>"}),a+="</tr>"};if(!checkds(p))return null;var y=p.toTable({status:h,vlabel:i,slabel:s}),O=y[0].length-1;return y.forEach(function(e,t){m(e,t)}),p.source&&(l=p.length+1,u&&l++,h&&l++,b+=": "+p.source,"."!==b.slice(-1)&&(b+="."),n='<tfoot><td colspan="'+l+'">'+b+"</td></tfoot>"),'<table class="'+c+'"><caption>'+(t.caption||p.label||"")+"</caption>"+n+"<tbody>"+a+"</tbody></table>"}function fromTable(e,t){if(void 0===e)return null;void 0===t&&(t={}),"boolean"!=typeof t.ovalue&&(t.ovalue=!1),"boolean"!=typeof t.ostatus&&(t.ostatus=!1);var a=t.vlabel||"Value",n=t.slabel||"Status",l=t.type||"array",r=t.label||"",o=t.header||null,i=[],s=[],u=[],c=[],d={},f={},h=function(e,t){for(var a=1,n=0,l=0;O>l;l++)a*=l>0?t[O-l]:1,n+=a*e[O-l-1];return n},v=function(){var t=e[S][a];u[h(j,s)]=isNaN(t)?null:t};switch(l){case"array":e=function(e){for(var t=e[0],a=e.slice(1),n=[],l=0,r=a.length;r>l;l++){for(var o=0,i=t.length,s={};i>o;o++)s[t[o]]=a[l][o];n.push(s)}return n}(e);break;case"object":e=function(e){for(var t=e.cols.map(function(e){return e.id}),a=e.rows,n=[],l=0,r=a.length;r>l;l++){for(var o=0,i=t.length,s={};i>o;o++)s[t[o]]=a[l].c[o].v;n.push(s)}return n}(e)}var b,p=e.length;t.hasOwnProperty("drop")&&"[object Array]"===Object.prototype.toString.call(t.drop)&&t.drop.length&&e.forEach(function(e){t.drop.forEach(function(t){delete e[t]})});for(var g in e[0])if(g!==a)if(g!==n){if(i.push(g),o)b=o.dimension[g],d[g]=b.category.index;else{d[g]=[];for(var m=0;p>m;m++){var y=e[m][g];-1===d[g].indexOf(y)&&d[g].push(y)}}s.push(d[g].length),f[g]={label:o?b.label:g,category:{index:d[g]}},o&&(f[g].category.label=b.category.label,b.category.unit&&(f[g].category.unit=b.category.unit))}else v=function(){var t=e[S][a],l=e[S][n];u[h(j,s)]=isNaN(t)?null:t,c[h(j,s)]=""===l?null:l};for(var O=i.length,S=0;p>S;S++){for(var j=[],x=0;O>x;x++){var E=i[x];j.push(d[E].indexOf(e[S][E]))}v()}var w={version:"2.0","class":"dataset",value:u,dimension:f,id:i,size:s};return r&&(w.label=r),c.length&&(w.status=c),o&&(o.label&&(w.label=o.label),o.source&&(w.source=o.source),o.updated&&(w.updated=o.updated),o.href&&(w.href=o.href),o.role&&(w.role=o.role)),t.ovalue&&(w.value=arr2obj(w,"value")),t.ostatus&&w.hasOwnProperty("status")&&(w.status=arr2obj(w,"status")),w}function arr2obj(e,t){var a={};return"[object Array]"===Object.prototype.toString.call(e[t])?(e[t].forEach(function(e,t){null!==e&&(a[t+""]=e)}),a):e[t]}function dcomma(e,t){return void 0===e||null===e?"":-1!==e.indexOf(t)?'"'+e+'"':e}function toCSV(e,t){if(void 0===e)return null;void 0===t&&(t={});var a="",n="jsonstat",l=t.rich===!0,r=l?"value":t.vlabel||"Value",o=l?"status":t.slabel||"Status",i=t.status===!0,s=t.na||"n/a",u=t.delimiter||",",c=t.separator||"|",d=";"===u?t.decimal||",":t.decimal||".",f=t.dsid||0,h=dataset(e,f);if(!checkds(h))return null;l&&(i=null!==h.status);var v=h.toTable({vlabel:r,slabel:o,status:i,field:l?"id":"label",content:l?"id":"label",type:"array"}),b=v[0].indexOf(r),p=i?v[0].indexOf(o):-1;return v.forEach(function(e,t){e.forEach(function(a,n){t&&n===b?null===a?e[n]=dcomma(s,u):"."!==d&&(e[n]=(e[n]+"").replace(".",d)):t&&n===p&&null===a?e[n]="":e[n]=dcomma(e[n],u)}),a+=e.join(u)+"\n"}),l&&(n+=u+d+u+c+"\n",["label","source","updated","href"].forEach(function(e){h[e]&&(n+=e+u+dcomma(h[e],u)+"\n")}),h.id.forEach(function(e,t){var a=[],l=h.Dimension(t),r=l.role,o=!1;n+="dimension"+u+dcomma(e,u)+u+dcomma(l.label,u)+u+l.length,"metric"===r&&l.__tree__.category.unit&&(o=!0),l.id.forEach(function(e,t){var r=[],i=l.Category(t);n+=u+dcomma(e,u)+u+dcomma(i.label,u),o&&(r.push(i.unit.hasOwnProperty("decimals")?i.unit.decimals:""),r.push(i.unit.label||""),i.unit.symbol&&(r.push(i.unit.symbol),r.push(i.unit.position)),a.push(dcomma(r.join(c),u)))}),null!==r&&"classification"!==r&&(n+=u+l.role,o&&(n+=u+a.join(u))),n+="\n"}),a=n+"data\n"+a),a}function fromCSV(e,t){if(void 0===e)return null;void 0===t&&(t={});var a,n,l,r=[],o=null,i=null,s=!1,u={time:[],geo:[],metric:[]},c="jsonstat"===e.substring(0,8),d=c?"value":t.vlabel,f=c?"status":t.slabel,h=c?e.substring(8,9):t.delimiter||",",v=";"===h?t.decimal||",":t.decimal||".",b=CSVToArray(e.trim(),h);if(c){for(v=b[0][1],l=b[0][2],b.shift();"data"!==b[0][0];)r.push(b.shift());b.shift(),i={dimension:{}},r.forEach(function(e){var t,a,n,r,o,c,d,f;switch(e[0]){case"dimension":if(i.dimension[e[1]]={},r=i.dimension[e[1]],r.label=e[2],r.category={},o=r.category,o.index=[],a={},n=2*e[3]+3,e.length>=n){for(t=4;n>t;t++)d=e[t],f=e[++t],Object.defineProperty(a,d,{value:f,writable:!0,configurable:!0,enumerable:!0}),o.label=a,o.index.push(d);"string"==typeof e[t]&&-1!==["time","geo","metric"].indexOf(e[t])&&(u[e[t]].push(e[1]),s=!0,"metric"===e[t]&&"string"==typeof e[++t]&&(o.unit={},o.index.forEach(function(a,n){var r=e[t+n].split(l);o.unit[a]={},c=o.unit[a],void 0!==r[0]&&""!==r[0]&&(c.decimals=1*r[0]),void 0!==r[1]&&""!==r[1]&&(c.label=r[1]),void 0!==r[2]&&""!==r[2]&&(c.symbol=r[2]),void 0!==r[1]&&-1!==["start","end"].indexOf(r[3])&&(c.position=r[3])})))}break;case"label":case"source":case"updated":case"href":i[e[0]]=e[1]||null}}),s&&(u.time.length||delete u.time,u.geo.length||delete u.geo,u.metric.length||delete u.metric,i.role=u)}if(a=b.length,n=b[0].length,void 0!==d){for(;n--;)if(b[0][n]===d){o=n;break}if(null===o)return null}else o=n-1,d=b[0][o];if(","===v)for(n=1;a>n;n++)b[n][o]=+b[n][o].replace(",",".");else for(n=1;a>n;n++)b[n][o]=+b[n][o];return fromTable(b,{header:i,vlabel:d,slabel:f,type:"array",label:t.label||"",ovalue:t.ovalue||!1,ostatus:t.ostatus||!1})}function checkds(e){if(null===e||0===e.length||"dataset"!==e["class"])return!1;for(var t=e.length,a=1;t--;)a*=e.Dimension(t).length;return a!==e.n?!1:!0}function CSVToArray(e,t){t=t||",";for(var a,n,l=RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),r=[[]],o=null;o=l.exec(e);)n=o[1],n.length&&n!=t&&r.push([]),a=o[2]?o[2].replace(RegExp('""',"g"),'"'):o[3],r[r.length-1].push(a);return r}function dataset(e,t){return void 0===e||null===e?null:(("string"==typeof e||void 0===e.length)&&(e=JSONstat(e)),0===e.length||"dataset"!==e["class"]&&"collection"!==e["class"]&&"bundle"!==e["class"]?null:"dataset"===e["class"]?e:e.Dataset(t))}function join(e,t){if(void 0===e||"[object Array]"!==Object.prototype.toString.call(e))return null;var a=JSON.parse(JSON.stringify(e)),n=a[0];if(!n.hasOwnProperty("version")||!n.hasOwnProperty("class")||"dataset"!==n["class"])return null;void 0===t&&(t={});var l=void 0===t.label?null:t.label,r=void 0===t.by?null:t.by,o=[];if(null===r){for(var i=1,s=a.length;s>i;i++)o=o.concat(a[i].value);return n.value=o,null!==l&&(n.label=l),n}var u,c,d,f=function(e,t,a){if("[object Array]"===Object.prototype.toString.call(e))e=e.concat(t);else for(var n in t)e[n]=0===t[n]?a:t[n];return e};a.forEach(function(e,t){var a=JSONstat(e).toTable({status:!0}),n=e.dimension[r].category;0===t?(o=[a[0]],u=n.index,c=n.label,d=n.unit):(u=f(u,n.index,t),c=f(c,n.label,t),d=f(d,n.unit,t)),o=o.concat(a.slice(1))});var h=fromTable(o);return n.value=h.value,n.size=h.size,n.status=h.status||null,n.label=l||"",n.href=null,n.dimension[r].category.index=u||null,n.dimension[r].category.label=c||null,n.dimension[r].category.unit=d||null,n}function fromSDMX(e,t){if("object"!=typeof e||!e.hasOwnProperty("dataSets")||"[object Array]"!==Object.prototype.toString.call(e.dataSets))return null;if(1!==e.dataSets.length)return null;if(!e.dataSets[0].hasOwnProperty("observations"))return null;void 0===t?t={ovalue:!1,ostatus:!1}:("boolean"!=typeof t.ovalue&&(t.ovalue=!1),"boolean"!=typeof t.ostatus&&(t.ostatus=!1));var a=e.structure,n=e.dataSets[0].observations,l=a.attributes.observation,r=a.dimensions;if(!r.hasOwnProperty("observation"))return null;if(r.hasOwnProperty("series")&&(null!==r.series||Object.keys(r.series).length))return null;var o=[],i=[],s={},u=[],c={time:[],geo:[]},d=function(){},f=function(e,t){for(var a=e.size,n=a.length-t.length;n--;)t.push(0);for(var l=0,r=a.length,o=0,i=1;r>l;l++)i*=l>0?a[r-l]:1,o+=i*t[r-l-1];return o},h=function(e){if(s[e.id]={label:e.name},e.hasOwnProperty("role"))switch(e.role){case"REF_AREA":c.geo.push(e.id);break;case"TIME_PERIOD":c.time.push(e.id)}Object.defineProperty(s[e.id],"category",{value:{index:[],label:{}},writable:!0,enumerable:!0}),o.push(e.id),i.push(e.values.length);var t=s[e.id].category;e.values.forEach(function(e){t.index.push(e.id),Object.defineProperty(t.label,e.id,{value:e.name,writable:!0,enumerable:!0})})},v=e.header.links.find(function(e){return"request"===e.rel}),b=l.findIndex(function(e){return"OBS_STATUS"===e.id});-1!==b&&(l[b].values.length?u=l[b].values:b=-1),r.observation.forEach(h),r.hasOwnProperty("dataSet")&&r.dataSet.forEach(h);var p={version:"2.0","class":"dataset",updated:e.header.prepared||null,source:e.header.sender.name||null,label:a.name||null,id:o,size:i,dimension:s,value:t.ovalue?{}:[]};v&&(p.link={alternate:[{type:"application/vnd.sdmx.data+json",href:v.href}]}),c.geo.length+c.time.length>0&&(c.time.length||delete c.time,c.geo.length||delete c.geo,p.role=c),-1!==b&&(p.status=t.ostatus?{}:[],p.extension={status:{label:{}}},u.forEach(function(e){p.extension.status.label[e.id]=e.name}),d=t.ostatus?function(){var e=n[g][b];null!==e&&(p.status[f(p,m)]=u[e].id)}:function(){var e=n[g][b];p.status[f(p,m)]=null===e?null:u[e].id}),b++;for(var g in n){var m=g.split(":");t.ovalue&&null===n[g][0]||(p.value[f(p,m)]=n[g][0]),d()}var y;if(!t.ovalue)for(y=i.reduce(function(e,t){return e*t})-p.value.length;y--;)p.value.push(null);if(!t.ostatus&&p.hasOwnProperty("status"))for(y=i.reduce(function(e,t){return e*t})-p.status.length;y--;)p.status.push(null);return p}const version="2.5.0";String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};

export {
	JSONstat,
	datalist,
	fromTable,
	fromCSV,
	toCSV,
	join,
	fromSDMX,
	version
};
