/*

JSON-stat Javascript Utilities Suite v. 2.4.4 (requires JJT 0.10+) (Nodejs module)
https://json-stat.com
https://github.com/badosa/JSON-stat/tree/master/utils

Copyright 2018 Xavier Badosa (https://xavierbadosa.com)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
or implied. See the License for the specific language governing
permissions and limitations under the License.

*/
var JSONstat=require("jsonstat"),JSONstatUtils=function(){"use strict";function e(e,t){if(void 0===e)return null;void 0===t&&(t={});var n="",l="",a=0,r=t.na||"n/a",i=t.dsid||0,u=t.vlabel||null,c=t.slabel||null,f=t.counter||!1,d=t.tblclass||"",v=t.numclass||"",h=t.valclass||"",b=t.status||!1,p=t.locale||"en-US",g=t.source||"Source",y=s(e,i),m=Number.toLocaleString?function(e){return e.toLocaleString(p)}:function(e){return e},O=f?function(e,t){n+=t?'<tr><td class="'+v+'">'+t+"</td>":'<tr><th class="'+v+'">#</th>',e.forEach(function(e,l){var a=x===l?' class="'+v+" "+h+'"':"",o=null===e?r:m(e);n+=t?"<td"+a+">"+o+"</td>":"<th"+a+">"+o+"</th>"}),n+="</tr>"}:function(e,t){n+="<tr>",e.forEach(function(e,l){var a=x===l?' class="'+v+" "+h+'"':"",o=null===e?r:m(e);n+=t?"<td"+a+">"+o+"</td>":"<th"+a+">"+o+"</th>"}),n+="</tr>"};if(!o(y))return null;var S=y.toTable({status:b,vlabel:u,slabel:c}),x=S[0].length-1;return S.forEach(function(e,t){O(e,t)}),y.source&&(a=y.length+1,f&&a++,b&&a++,g+=": "+y.source,"."!==g.slice(-1)&&(g+="."),l='<tfoot><td colspan="'+a+'">'+g+"</td></tfoot>"),'<table class="'+d+'"><caption>'+(t.caption||y.label||"")+"</caption>"+l+"<tbody>"+n+"</tbody></table>"}function t(e,t){if(void 0===e)return null;void 0===t&&(t={}),"boolean"!=typeof t.ovalue&&(t.ovalue=!1),"boolean"!=typeof t.ostatus&&(t.ostatus=!1);var l=t.vlabel||"Value",a=t.slabel||"Status",r=t.type||"array",o=t.label||"",i=t.header||null,s=[],u=[],c=[],f=[],d={},v={},h=function(e,t){for(var n=1,l=0,a=0;S>a;a++)n*=a>0?t[S-a]:1,l+=n*e[S-a-1];return l},b=function(){var t=e[x][l];c[h(j,u)]=isNaN(t)?null:t};switch(r){case"array":e=function(e){for(var t=e[0],n=e.slice(1),l=[],a=0,r=n.length;r>a;a++){for(var o=0,i=t.length,s={};i>o;o++)s[t[o]]=n[a][o];l.push(s)}return l}(e);break;case"object":e=function(e){for(var t=e.cols.map(function(e){return e.id}),n=e.rows,l=[],a=0,r=n.length;r>a;a++){for(var o=0,i=t.length,s={};i>o;o++)s[t[o]]=n[a].c[o].v;l.push(s)}return l}(e)}var p,g=e.length;for(var y in e[0])if(y!==l)if(y!==a){if(s.push(y),i)p=i.dimension[y],d[y]=p.category.index;else{d[y]=[];for(var m=0;g>m;m++){var O=e[m][y];-1===d[y].indexOf(O)&&d[y].push(O)}}u.push(d[y].length),v[y]={label:i?p.label:y,category:{index:d[y]}},i&&(v[y].category.label=p.category.label,p.category.unit&&(v[y].category.unit=p.category.unit))}else b=function(){var t=e[x][l],n=e[x][a];c[h(j,u)]=isNaN(t)?null:t,f[h(j,u)]=""===n?null:n};for(var S=s.length,x=0;g>x;x++){for(var j=[],E=0;S>E;E++){var w=s[E];j.push(d[w].indexOf(e[x][w]))}b()}var P={version:"2.0","class":"dataset",value:c,dimension:v,id:s,size:u};return o&&(P.label=o),f.length&&(P.status=f),i&&(i.label&&(P.label=i.label),i.source&&(P.source=i.source),i.updated&&(P.updated=i.updated),i.href&&(P.href=i.href),i.role&&(P.role=i.role)),t.ovalue&&(P.value=n(P,"value")),t.ostatus&&P.hasOwnProperty("status")&&(P.status=n(P,"status")),P}function n(e,t){var n={};return"[object Array]"===Object.prototype.toString.call(e[t])?(e[t].forEach(function(e,t){null!==e&&(n[t+""]=e)}),n):e[t]}function l(e,t){return void 0===e||null===e?"":-1!==e.indexOf(t)?'"'+e+'"':e}function a(e,t){if(void 0===e)return null;void 0===t&&(t={});var n="",a="jsonstat",r=t.rich===!0,i=r?"value":t.vlabel||"Value",u=r?"status":t.slabel||"Status",c=t.status===!0,f=t.na||"n/a",d=t.delimiter||",",v=t.separator||"|",h=";"===d?t.decimal||",":t.decimal||".",b=t.dsid||0,p=s(e,b);if(!o(p))return null;r&&(c=null!==p.status);var g=p.toTable({vlabel:i,slabel:u,status:c,field:r?"id":"label",content:r?"id":"label",type:"array"}),y=g[0].indexOf(i),m=c?g[0].indexOf(u):-1;return g.forEach(function(e,t){e.forEach(function(n,a){t&&a===y?null===n?e[a]=l(f,d):"."!==h&&(e[a]=(e[a]+"").replace(".",h)):t&&a===m&&null===n?e[a]="":e[a]=l(e[a],d)}),n+=e.join(d)+"\n"}),r&&(a+=d+h+d+v+"\n",["label","source","updated","href"].forEach(function(e){p[e]&&(a+=e+d+l(p[e],d)+"\n")}),p.id.forEach(function(e,t){var n=[],r=p.Dimension(t),o=r.role,i=!1;a+="dimension"+d+l(e,d)+d+l(r.label,d)+d+r.length,"metric"===o&&r.__tree__.category.unit&&(i=!0),r.id.forEach(function(e,t){var o=[],s=r.Category(t);a+=d+l(e,d)+d+l(s.label,d),i&&(o.push(s.unit.hasOwnProperty("decimals")?s.unit.decimals:""),o.push(s.unit.label||""),s.unit.symbol&&(o.push(s.unit.symbol),o.push(s.unit.position)),n.push(l(o.join(v),d)))}),null!==o&&"classification"!==o&&(a+=d+r.role,i&&(a+=d+n.join(d))),a+="\n"}),n=a+"data\n"+n),n}function r(e,n){if(void 0===e)return null;void 0===n&&(n={});var l,a,r,o=[],s=null,u=null,c=!1,f={time:[],geo:[],metric:[]},d="jsonstat"===e.substring(0,8),v=d?"value":n.vlabel,h=d?"status":n.slabel,b=d?e.substring(8,9):n.delimiter||",",p=";"===b?n.decimal||",":n.decimal||".",g=i(e.trim(),b);if(d){for(p=g[0][1],r=g[0][2],g.shift();"data"!==g[0][0];)o.push(g.shift());g.shift(),u={dimension:{}},o.forEach(function(e){var t,n,l,a,o,i,s,d;switch(e[0]){case"dimension":if(u.dimension[e[1]]={},a=u.dimension[e[1]],a.label=e[2],a.category={},o=a.category,o.index=[],n={},l=2*e[3]+3,e.length>=l){for(t=4;l>t;t++)s=e[t],d=e[++t],Object.defineProperty(n,s,{value:d,writable:!0,configurable:!0,enumerable:!0}),o.label=n,o.index.push(s);"string"==typeof e[t]&&-1!==["time","geo","metric"].indexOf(e[t])&&(f[e[t]].push(e[1]),c=!0,"metric"===e[t]&&"string"==typeof e[++t]&&(o.unit={},o.index.forEach(function(n,l){var a=e[t+l].split(r);o.unit[n]={},i=o.unit[n],void 0!==a[0]&&""!==a[0]&&(i.decimals=1*a[0]),void 0!==a[1]&&""!==a[1]&&(i.label=a[1]),void 0!==a[2]&&""!==a[2]&&(i.symbol=a[2]),void 0!==a[1]&&-1!==["start","end"].indexOf(a[3])&&(i.position=a[3])})))}break;case"label":case"source":case"updated":case"href":u[e[0]]=e[1]||null}}),c&&(f.time.length||delete f.time,f.geo.length||delete f.geo,f.metric.length||delete f.metric,u.role=f)}if(l=g.length,a=g[0].length,void 0!==v){for(;a--;)if(g[0][a]===v){s=a;break}if(null===s)return null}else s=a-1,v=g[0][s];if(","===p)for(a=1;l>a;a++)g[a][s]=+g[a][s].replace(",",".");else for(a=1;l>a;a++)g[a][s]=+g[a][s];return t(g,{header:u,vlabel:v,slabel:h,type:"array",label:n.label||"",ovalue:n.ovalue||!1,ostatus:n.ostatus||!1})}function o(e){if(null===e||0===e.length||"dataset"!==e["class"])return!1;for(var t=e.length,n=1;t--;)n*=e.Dimension(t).length;return n!==e.n?!1:!0}function i(e,t){t=t||",";for(var n,l,a=RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),r=[[]],o=null;o=a.exec(e);)l=o[1],l.length&&l!=t&&r.push([]),n=o[2]?o[2].replace(RegExp('""',"g"),'"'):o[3],r[r.length-1].push(n);return r}function s(e,t){return void 0===e||null===e?null:(("string"==typeof e||void 0===e.length)&&(e=JSONstat(e)),0===e.length||"dataset"!==e["class"]&&"collection"!==e["class"]&&"bundle"!==e["class"]?null:"dataset"===e["class"]?e:e.Dataset(t))}function u(e,n){if(void 0===e||"[object Array]"!==Object.prototype.toString.call(e))return null;var l=JSON.parse(JSON.stringify(e)),a=l[0];if(!a.hasOwnProperty("version")||!a.hasOwnProperty("class")||"dataset"!==a["class"])return null;void 0===n&&(n={});var r=void 0===n.label?null:n.label,o=void 0===n.by?null:n.by,i=[];if(null===o){for(var s=1,u=l.length;u>s;s++)i=i.concat(l[s].value);return a.value=i,null!==r&&(a.label=r),a}var c,f,d,v=function(e,t,n){if("[object Array]"===Object.prototype.toString.call(e))e=e.concat(t);else for(var l in t)e[l]=0===t[l]?n:t[l];return e};l.forEach(function(e,t){var n=JSONstat(e).toTable({status:!0}),l=e.dimension[o].category;0===t?(i=[n[0]],c=l.index,f=l.label,d=l.unit):(c=v(c,l.index,t),f=v(f,l.label,t),d=v(d,l.unit,t)),i=i.concat(n.slice(1))});var h=t(i);return a.value=h.value,a.size=h.size,a.status=h.status||null,a.label=r||"",a.href=null,a.dimension[o].category.index=c||null,a.dimension[o].category.label=f||null,a.dimension[o].category.unit=d||null,a}function c(e,t){if("object"!=typeof e||!e.hasOwnProperty("dataSets")||"[object Array]"!==Object.prototype.toString.call(e.dataSets))return null;if(1!==e.dataSets.length)return null;if(!e.dataSets[0].hasOwnProperty("observations"))return null;void 0===t?t={ovalue:!1,ostatus:!1}:("boolean"!=typeof t.ovalue&&(t.ovalue=!1),"boolean"!=typeof t.ostatus&&(t.ostatus=!1));var n=e.structure,l=e.dataSets[0].observations,a=n.attributes.observation,r=n.dimensions;if(!r.hasOwnProperty("observation"))return null;if(r.hasOwnProperty("series")&&(null!==r.series||Object.keys(r.series).length))return null;var o=[],i=[],s={},u=[],c={time:[],geo:[]},f=function(){},d=function(e,t){for(var n=e.size,l=n.length-t.length;l--;)t.push(0);for(var a=0,r=n.length,o=0,i=1;r>a;a++)i*=a>0?n[r-a]:1,o+=i*t[r-a-1];return o},v=function(e){if(s[e.id]={label:e.name},e.hasOwnProperty("role"))switch(e.role){case"REF_AREA":c.geo.push(e.id);break;case"TIME_PERIOD":c.time.push(e.id)}Object.defineProperty(s[e.id],"category",{value:{index:[],label:{}},writable:!0,enumerable:!0}),o.push(e.id),i.push(e.values.length);var t=s[e.id].category;e.values.forEach(function(e){t.index.push(e.id),Object.defineProperty(t.label,e.id,{value:e.name,writable:!0,enumerable:!0})})},h=e.header.links.find(function(e){return"request"===e.rel}),b=a.findIndex(function(e){return"OBS_STATUS"===e.id});-1!==b&&(a[b].values.length?u=a[b].values:b=-1),r.observation.forEach(v),r.hasOwnProperty("dataSet")&&r.dataSet.forEach(v);var p={version:"2.0","class":"dataset",updated:e.header.prepared||null,source:e.header.sender.name||null,label:n.name||null,id:o,size:i,dimension:s,value:t.ovalue?{}:[]};h&&(p.link={alternate:[{type:"application/vnd.sdmx.data+json",href:h.href}]}),c.geo.length+c.time.length>0&&(c.time.length||delete c.time,c.geo.length||delete c.geo,p.role=c),-1!==b&&(p.status=t.ostatus?{}:[],p.extension={status:{label:{}}},u.forEach(function(e){p.extension.status.label[e.id]=e.name}),f=t.ostatus?function(){var e=l[g][b];null!==e&&(p.status[d(p,y)]=u[e].id)}:function(){var e=l[g][b];p.status[d(p,y)]=null===e?null:u[e].id}),b++;for(var g in l){var y=g.split(":");t.ovalue&&null===l[g][0]||(p.value[d(p,y)]=l[g][0]),f()}var m;if(!t.ovalue)for(m=i.reduce(function(e,t){return e*t})-p.value.length;m--;)p.value.push(null);if(!t.ostatus&&p.hasOwnProperty("status"))for(m=i.reduce(function(e,t){return e*t})-p.status.length;m--;)p.status.push(null);return p}return String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},{datalist:e,fromTable:t,fromCSV:r,toCSV:a,join:u,fromSDMX:c,version:"2.4.4"}}();module.exports=JSONstatUtils;
